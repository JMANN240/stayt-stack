use axum::{Json, extract::State, http::StatusCode};
use {{crate_name}}_lib::RegisterRequest;

use crate::{AppState, db::user::DbUser, util::internal_server_error};

pub async fn register(
    State(state): State<AppState>,
    Json(register_request): Json<RegisterRequest>,
) -> Result<(StatusCode, String), (StatusCode, String)> {
    let maybe_db_user = DbUser::get_by_username(&state.pool, &register_request.username)
        .await
        .map_err(internal_server_error)?;

    if maybe_db_user.is_some() {
        return Err((StatusCode::CONFLICT, String::from("username is taken")));
    }

    if register_request.password != register_request.confirm_password {
        return Err((
            StatusCode::BAD_REQUEST,
            String::from("passwords do not match"),
        ));
    }

    let query_result = DbUser::insert(
        &state.pool,
        &register_request.username,
        &register_request.password,
    )
    .await
    .map_err(internal_server_error)?;

    Ok((
        StatusCode::CREATED,
        query_result.last_insert_rowid().to_string(),
    ))
}
